name: Secrets & Connectivity Check
on:
  workflow_dispatch: {}   # run manually from the Actions tab

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps
        run: |
          pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 pandas

      - name: Sanity check secret presence (no values shown)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_CREDENTIALS_TENDERS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for K in GOOGLE_SERVICE_ACCOUNT_JSON GOOGLE_SHEET_ID GOOGLE_DRIVE_FOLDER_ID OPENAI_API_KEY; do
            if [ -z "${!K}" ]; then
              echo "::error title=Missing secret::${K} is NOT set"
            else
              echo "::notice title=Secret present::${K} is set"
            fi
          done

      - name: Run connectivity checks (Sheets + Drive + OpenAI key present)
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_CREDENTIALS_TENDERS }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python - << 'PY'
          import os, sys, json, io, time, base64
          from datetime import datetime, timezone
          import pandas as pd
          from google.oauth2.service_account import Credentials
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseUpload

          # Fail fast if any required secret missing
          required = ["GOOGLE_SERVICE_ACCOUNT_JSON","GOOGLE_SHEET_ID","GOOGLE_DRIVE_FOLDER_ID","OPENAI_API_KEY"]
          missing = [k for k in required if not os.getenv(k)]
          if missing:
            print("âŒ Missing secrets:", ", ".join(missing)); sys.exit(1)

          # Parse service account JSON (supports raw JSON or base64-encoded JSON)
          raw = os.environ["GOOGLE_SERVICE_ACCOUNT_JSON"]
          try:
            sa = json.loads(raw)
          except json.JSONDecodeError:
            try:
              sa = json.loads(base64.b64decode(raw).decode("utf-8"))
            except Exception as e:
              print("âŒ Could not decode GOOGLE_SERVICE_ACCOUNT_JSON as JSON or base64 JSON:", e)
              sys.exit(1)

          scopes = [
              "https://www.googleapis.com/auth/spreadsheets.readonly",
              "https://www.googleapis.com/auth/drive"
          ]
          creds = Credentials.from_service_account_info(sa, scopes=scopes)

          # 1) SHEETS: read header row
          try:
            sheets = build("sheets", "v4", credentials=creds)
            sheet_id = os.environ["GOOGLE_SHEET_ID"]
            r = sheets.spreadsheets().values().get(
                spreadsheetId=sheet_id, range="A1:N1"
            ).execute()
            headers = r.get("values", [[]])[0] if r.get("values") else []
            print("âœ… Sheets connection OK. Headers:", headers)
          except Exception as e:
            print("âŒ Sheets check failed:", e); sys.exit(2)

          # 2) DRIVE: upload a tiny txt then trash it
          try:
            drive = build("drive", "v3", credentials=creds)
            folder_id = os.environ["GOOGLE_DRIVE_FOLDER_ID"]
            content = f"Connectivity OK @ {datetime.now(timezone.utc).isoformat()}\n"
            media = MediaIoBaseUpload(io.BytesIO(content.encode("utf-8")), mimetype="text/plain")
            meta = {"name": f"_connectivity_check_{int(time.time())}.txt", "parents": [folder_id]}
            file = drive.files().create(body=meta, media_body=media, fields="id, webViewLink").execute()
            print("âœ… Drive upload OK. File link:", file.get("webViewLink"))
            # move to trash to avoid clutter
            drive.files().update(fileId=file["id"], body={"trashed": True}).execute()
            print("ðŸ—‘ï¸  Test file moved to trash.")
          except Exception as e:
            print("âŒ Drive check failed:", e); sys.exit(3)

          # 3) OPENAI key presence (no paid call)
          if os.getenv("OPENAI_API_KEY", "").startswith("sk-"):
            print("âœ… OpenAI key present.")
          else:
            print("âŒ OPENAI_API_KEY is missing or malformed."); sys.exit(4)

          print("ðŸŽ‰ All connectivity checks passed.")
          PY
